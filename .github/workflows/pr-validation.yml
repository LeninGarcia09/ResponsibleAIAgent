# PR Validation Workflow
# Runs on pull requests to validate changes before merge

name: PR Validation

on:
  pull_request:
    branches: [main, master]

jobs:
  # ============================================
  # Validate Backend Changes
  # ============================================
  validate-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate system prompt syntax
        run: |
          python -c "from rai_system_prompt import SYSTEM_PROMPT, RESPONSE_FORMAT_INSTRUCTIONS; print('✓ System prompt loaded successfully')"

      - name: Check for required RAI tools in prompt
        run: |
          python -c "
          from rai_system_prompt import SYSTEM_PROMPT
          required_tools = ['Prompt Shields', 'Azure AI Content Safety', 'Groundedness Detection', 'Fairlearn', 'Presidio']
          missing = [t for t in required_tools if t not in SYSTEM_PROMPT]
          if missing:
              print(f'⚠ Warning: Missing tools in prompt: {missing}')
          else:
              print('✓ All required tools mentioned in system prompt')
          "

  # ============================================
  # Validate Frontend Changes
  # ============================================
  validate-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: https://rai-backend.graymoss-a8a3aef8.westus3.azurecontainerapps.io/api

  # ============================================
  # Documentation Validation
  # ============================================
  validate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links in docs
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          folder-path: 'docs/'
          config-file: '.github/mlc_config.json'
        continue-on-error: true

      - name: Validate README exists
        run: |
          if [ -f "README.md" ]; then
            echo "✓ README.md exists"
          else
            echo "✗ README.md not found"
            exit 1
          fi

  # ============================================
  # Security Scan
  # ============================================
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
        continue-on-error: true

      - name: Check for hardcoded API keys
        run: |
          echo "Checking for potential API keys..."
          if grep -r "sk-[a-zA-Z0-9]" --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" . 2>/dev/null; then
            echo "⚠ Warning: Potential API key found"
          else
            echo "✓ No hardcoded API keys detected"
          fi
